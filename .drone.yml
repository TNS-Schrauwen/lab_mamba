---
kind: pipeline
type: docker
name: build-amd64
platform:
  arch: amd64
  os: linux

steps:
  - name: publish
    image: plugins/ecr
    environment:
      ECR_REGISTRY:
        from_secret: ecr_registry
      REPO_NAME:
        from_secret: repo_name
    settings:
      access_key:
        from_secret: aws_access_key_id
      secret_key:
        from_secret: aws_secret_access_key
      repo:
        from_secret: repo_name
      registry:
        from_secret: ecr_registry
      region:
        us-west-2
      tags:
        - ${DRONE_BRANCH/\//-}-linux-amd64
      cache_from:
        - ${ECR_REGISTRY}/${REPO_NAME}:${DRONE_BRANCH/\//-}-linux-amd64
        - ${ECR_REGISTRY}/${REPO_NAME}:main-linux-amd64
      create_repository: true

---
kind: pipeline
type: docker
name: build-arm64
platform:
  arch: arm64
  os: linux

steps:
  - name: publish
    image: plugins/ecr
    settings:
      access_key:
        from_secret: aws_access_key_id
      secret_key:
        from_secret: aws_secret_access_key
      repo:
        from_secret: repo_name
      registry:
        from_secret: ecr_registry
      region:
        us-west-2
      tags:
        - ${DRONE_BRANCH/\//-}-linux-arm64
      cache_from:
        - ${ECR_REGISTRY}/${REPO_NAME}:${DRONE_BRANCH/\//-}-linux-arm64
        - ${ECR_REGISTRY}/${REPO_NAME}:main-linux-arm64
      create_repository: true

