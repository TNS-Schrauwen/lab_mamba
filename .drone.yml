---
name: build-and-push-multi-arch
kind: pipeline
type: docker
platform:
  arch: arm64
  os: linux

steps:
  - name: build-multi-arch
    image: docker:24-cli
    environment:
        DOCKER_USERNAME:
          from_secret: docker_username
        DOCKER_TOKEN:
          from_secret: docker_token  
        DOCKER_BUILDKIT: "1"
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker buildx create --driver docker-container --name multiarch --use || docker buildx use multiarch
      - docker buildx inspect --bootstrap

      # Force HTTP with registry.insecure=true and push=true
      - >
        docker buildx build
        --platform linux/amd64,linux/arm64
        --output=type=image,name=10.228.2.36:5000/lab-mamba:latest,push=true,registry.insecure=true
        .
volumes:
  - name: docker-sock
    host:
      path: /var/run/docker.sock
